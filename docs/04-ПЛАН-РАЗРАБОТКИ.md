# ПЛАН РАЗРАБОТКИ
## Проект: CurRate Go Rewrite

**Версия:** 1.0
**Дата:** 19 декабря 2025

---

## 1. ОБЗОР ПРОЕКТА

### 1.1. Цели
- Переписать Python приложение CurRate на Go
- Создать standalone exe-файл для Windows 10 (22H2+) / Windows 11
- Сохранить 100% функциональности текущего приложения
- Улучшить производительность и размер дистрибутива

### 1.2. Ограничения
- **Язык:** Go 1.26
- **GUI:** Wails v2.11.0 (WebView2 + HTML/CSS/JS)
- **Целевая платформа:** Windows 10 (22H2+) / Windows 11
- **Размер exe:** не более 10 MB (с UPX компрессией)
- **Покрытие тестами:** минимум 95% (достигнуто 97.2%)

---

## 2. ЭТАПЫ РАЗРАБОТКИ

### Этап 0: Подготовка (1-2 дня)

#### Задачи:
1. ✅ Изучение текущего Python кода
2. ✅ Анализ архитектуры
3. ✅ Выбор языка программирования (Go)
4. ✅ Подготовка технической документации

#### Результат:
- Техническое задание
- Архитектурный дизайн
- План разработки
- Технологический стек

---

### Этап 1: Настройка окружения (0.5 дня)

#### Задачи:
1. Установка Go 1.26 на dev машинах
2. Установка необходимых инструментов:
   - Wails CLI v2.11.0
   - golangci-lint
   - go-delve (debugger)
   - UPX (опционально)
3. Создание структуры проекта
4. Инициализация Git репозитория
5. Настройка .gitignore и .golangci.yml
6. Создание go.mod и wails.json

#### Команды:
```bash
# Установка Go
winget install GoLang.Go

# Установка Wails CLI
go install github.com/wailsapp/wails/v2/cmd/wails@latest

# Установка инструментов
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
go install github.com/go-delve/delve/cmd/dlv@latest

# Инициализация проекта
mkdir currate-go && cd currate-go
go mod init github.com/bivlked/currate-go

# Создание структуры
mkdir -p frontend/{scripts,styles} internal/{app,converter,parser,cache,models} pkg/utils docs
```

#### Критерии приемки:
- ✅ Go установлен и работает (`go version`)
- ✅ Структура папок создана
- ✅ go.mod инициализирован
- ✅ Git репозиторий создан

---

### Этап 2: Базовые модели и утилиты (1 день)

#### Задачи:
1. Реализовать `internal/models`:
   - `currency.go` - тип Currency, константы USD/EUR
   - `rate.go` - ExchangeRate, ConversionResult
2. Реализовать `pkg/utils`:
   - `number.go` - парсинг суммы из строки (ParseAmount)
3. Написать unit-тесты для моделей
4. Написать table-driven тесты для ParseAmount

#### Файлы:
- `internal/models/currency.go` (~50 строк)
- `internal/models/rate.go` (~40 строк)
- `pkg/utils/number.go` (~80 строк)
- `internal/models/currency_test.go` (~100 строк)
- `pkg/utils/number_test.go` (~150 строк)

#### Критерии приемки:
- ✅ Все тесты проходят (`go test ./...`)
- ✅ Покрытие моделей >= 90%
- ✅ ParseAmount корректно обрабатывает различные форматы

#### Примерное время: **6-8 часов**

---

### Этап 3: HTTP клиент и парсер ЦБ РФ (2-3 дня)

#### Задачи:
1. Реализовать `internal/parser/client.go`:
   - HTTPClient с таймаутом
   - Transport с connection pooling
2. Реализовать retry логику в `internal/parser/client.go`:
   - RetryStrategy с экспоненциальным backoff
3. Реализовать обработку ошибок в `internal/parser/xml.go`:
   - Кастомные ошибки (NetworkError, HTTPError, ParseError)
   - Метод UserMessage() для каждой ошибки
4. Реализовать `internal/parser/cbr.go`:
   - parser.FetchRates(date) возвращает *RateData
   - Парсинг XML ответа с encoding/xml
   - Обработка номинала валюты
   - Retry-логика
5. Написать unit-тесты с моками HTTP
6. Написать integration тест (реальный запрос к cbr.ru)

#### Файлы:
- `internal/parser/client.go` (~60 строк)
- Retry логика в `internal/parser/client.go` (~40 строк)
- Обработка ошибок в `internal/parser/xml.go` (~120 строк)
- `internal/parser/cbr.go` (~250 строк)
- `internal/parser/cbr_test.go` (~300 строк)

#### Зависимости:
```bash
# encoding/xml входит в стандартную библиотеку Go
```

#### Критерии приемки:
- ✅ Парсер корректно извлекает курс USD и EUR
- ✅ Retry-логика работает (3 попытки с backoff)
- ✅ Все ошибки обрабатываются с понятными сообщениями
- ✅ Покрытие >= 80%
- ✅ Integration тест проходит (с `-short` для пропуска в CI)

#### Примерное время: **12-18 часов**

---

### Этап 4: LRU кэш (1 день)

#### Задачи:
1. Реализовать `internal/cache/lru.go`:
   - LRUCache с sync.RWMutex
   - Использование container/list
   - Методы Get, Set, Clear, Size
   - TTL проверка
   - LRU вытеснение при переполнении
2. Написать unit-тесты:
   - Тест LRU вытеснения
   - Тест TTL истечения
   - Тест thread-safety (goroutines)

#### Файлы:
- `internal/cache/lru.go` (~150 строк)
- `internal/cache/lru_test.go` (~250 строк)

#### Критерии приемки:
- ✅ LRU алгоритм работает корректно
- ✅ TTL истекшие записи удаляются
- ✅ Thread-safe (тест с 100 goroutines)
- ✅ Покрытие >= 90%

#### Примерное время: **6-8 часов**

---

### Этап 5: Конвертер валют (1-2 дня)

#### Задачи:
1. Реализовать `internal/converter/validator.go`:
   - ValidateAmount
   - ValidateDate
2. Реализовать `internal/converter/formatter.go`:
   - FormatResult (с разделителями тысяч и запятой)
   - formatNumber
   - addThousandsSeparator
3. Реализовать `internal/converter/converter.go`:
   - Converter.Convert()
   - Интеграция с Parser и Cache
   - Обработка ошибок
4. Написать unit-тесты с моками Parser и Cache

#### Файлы:
- `internal/converter/validator.go` (~40 строк)
- `internal/converter/formatter.go` (~80 строк)
- `internal/converter/converter.go` (~100 строк)
- `internal/converter/converter_test.go` (~300 строк)

#### Критерии приемки:
- ✅ Конвертация работает корректно
- ✅ Форматирование идентично Python версии
- ✅ Кэширование используется (проверить через мок)
- ✅ Покрытие >= 85%

#### Примерное время: **8-12 часов**

---

### Этап 6: GUI на Wails v2 (3-4 дня) ✅ **ЗАВЕРШЕНО**

#### Задачи:
1. ✅ Изучить документацию и примеры Wails v2
2. ✅ Настроить Wails проект (wails.json, main_gui.go)
3. ✅ Реализовать `internal/app/app.go`:
   - App структура с методами для frontend
   - Convert() метод для конвертации
   - GetRate() метод для live preview курса
   - Интеграция с Converter
4. ✅ Реализовать frontend:
   - `frontend/index.html` - HTML структура
   - `frontend/scripts/main.js` - основная логика
   - `frontend/scripts/calendar.js` - календарь
   - `frontend/scripts/status-bar.js` - строка состояния
   - `frontend/styles/main.css` - основные стили
   - `frontend/styles/calendar.css` - стили календаря
5. ✅ Обработка ошибок в строке состояния (без всплывающих окон)
6. ✅ Тестирование вручную

#### Файлы:
- `main_gui.go` (~80 строк)
- `internal/app/app.go` (~150 строк)
- `frontend/index.html` (~100 строк)
- `frontend/scripts/*.js` (~400 строк)
- `frontend/styles/*.css` (~300 строк)

#### Зависимости:
```bash
go get github.com/wailsapp/wails/v2@v2.11.0
# navigator.clipboard используется через WebView2 (встроен)
```

#### Критерии приемки:
- ✅ Окно открывается и отображается корректно
- ✅ Все элементы UI функционируют
- ✅ Конвертация работает через GUI
- ✅ Копирование в буфер обмена работает
- ✅ Сообщения об ошибках отображаются
- ✅ UI не блокируется во время HTTP запроса

#### Примерное время: **18-24 часа**

---

### Этап 7: Главный файл и сборка (0.5 дня)

#### Задачи:
1. Реализовать `main_gui.go`:
   - Инициализация компонентов
   - Dependency injection
   - Запуск GUI
2. Настроить сборку:
   - go build с флагами оптимизации
   - Тестирование exe на чистой системе
   - Опционально: UPX компрессия
3. Создать README.md

#### Файлы:
- `main_gui.go` (~50 строк)
- `README.md` (~200 строк)
- `build.bat` или `Makefile`

#### Команды сборки:
```bash
# Оптимизированная сборка
wails build -ldflags="-s -w" -o CurRate.exe

# С UPX
upx --best --lzma currate.exe
```

#### Критерии приемки:
- ✅ exe собирается без ошибок
- ✅ Размер <= 10 MB (до UPX) или <= 5 MB (с UPX)
- ✅ Приложение запускается на Windows 11
- ✅ Все функции работают

#### Примерное время: **3-4 часа**

---

### Этап 8: Тестирование и отладка (2-3 дня)

#### Задачи:
1. **Юнит-тестирование:**
   - Запуск всех тестов
   - Проверка покрытия (>= 70%)
   - Исправление failing тестов
2. **Интеграционное тестирование:**
   - Реальные запросы к cbr.ru
   - Проверка кэширования
   - Проверка retry-логики
3. **Ручное тестирование GUI:**
   - Все сценарии использования
   - Граничные случаи
   - Обработка ошибок
4. **Тестирование на разных системах:**
   - Windows 11 Pro
   - Windows 10 (если есть доступ)
   - Разные разрешения экрана
5. **Исправление найденных багов**

#### Тестовые сценарии:
1. Конвертация 1000 USD на сегодня
2. Конвертация 500 EUR на дату месячной давности
3. Попытка выбрать дату в будущем (должна ошибка)
4. Ввод отрицательной суммы (должна ошибка)
5. Ввод некорректной суммы "abc" (должна ошибка)
6. Отключение интернета и попытка конвертации (должна ошибка)
7. Повторная конвертация той же пары (должен использоваться кэш)
8. Копирование результата в буфер
9. Вставка результата в Notepad

#### Команды:
```bash
# Все тесты
go test ./...

# С покрытием
go test -cover ./...

# HTML отчет покрытия
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

#### Критерии приемки:
- ✅ Все unit-тесты проходят
- ✅ Покрытие >= 70% (target: 80%+)
- ✅ Все ручные сценарии проходят
- ✅ Нет критических багов
- ✅ Производительность приемлема

#### Примерное время: **12-18 часов**

---

### Этап 9: Документация и релиз (1 день)

#### Задачи:
1. Финализация README.md:
   - Описание проекта
   - Скриншоты
   - Инструкция по использованию
   - Системные требования
2. Создание CHANGELOG.md
3. Создание LICENSE (MIT)
4. Настройка GitHub Actions для CI/CD (опционально)
5. Создание GitHub Release:
   - Тег v1.0.0
   - Загрузка currate.exe
   - Release notes
6. Обновление документации в репозитории

#### Файлы:
- `README.md`
- `CHANGELOG.md`
- `LICENSE`
- `.github/workflows/build.yml` (опционально)

#### Критерии приемки:
- ✅ README понятен и содержит всю необходимую информацию
- ✅ LICENSE добавлен
- ✅ GitHub Release создан
- ✅ CI/CD работает (если настроен)

#### Примерное время: **4-6 часов**

---

## 3. РАСПРЕДЕЛЕНИЕ ЗАДАЧ ПО РОЛЯМ

### 3.1. Backend разработчик (Go)
- Этап 2: Модели и утилиты
- Этап 3: HTTP клиент и парсер
- Этап 4: LRU кэш
- Этап 5: Конвертер валют
- Этап 7: Главный файл

**Итого:** ~45-60 часов (1-1.5 недели full-time)

### 3.2. Frontend разработчик (Go GUI)
- Этап 1: Настройка окружения (помощь)
- Этап 6: GUI на Walk
- Этап 8: Ручное тестирование GUI

**Итого:** ~25-35 часов (0.5-1 неделя full-time)

### 3.3. QA Engineer
- Этап 8: Тестирование и отладка
- Этап 9: Финальная проверка перед релизом

**Итого:** ~15-20 часов (2-3 дня)

### 3.4. Tech Lead / Architect
- Этап 0: Подготовка (готово ✅)
- Этап 1: Настройка окружения (помощь команде)
- Код-ревью на каждом этапе
- Этап 9: Релиз

**Итого:** ~10-15 часов (консультации + ревью)

---

## 4. ВРЕМЕННЫЕ ОЦЕНКИ

### 4.1. Оптимистичный сценарий
- **Общее время:** 90-110 часов
- **С командой из 2-3 человек:** 1.5-2 недели
- **С одним разработчиком:** 3-4 недели

### 4.2. Реалистичный сценарий
- **Общее время:** 120-150 часов
- **С командой из 2-3 человек:** 2-3 недели
- **С одним разработчиком:** 4-5 недель

### 4.3. Пессимистичный сценарий (с учетом рисков)
- **Общее время:** 160-200 часов
- **С командой из 2-3 человек:** 3-4 недели
- **С одним разработчиком:** 5-7 недель

---

## 5. РИСКИ И МИТИГАЦИЯ

### 5.1. Технические риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Изменение структуры сайта ЦБ РФ | Низкая | Высокое | Версионирование парсера, мониторинг |
| Проблемы с Walk GUI | Средняя | Высокое | PoC на этапе 1, альтернатива Fyne |
| Превышение размера exe | Низкая | Среднее | UPX компрессия, оптимизация |
| Недостаток опыта с Go | Средняя | Среднее | Обучение, менторство |

### 5.2. Проектные риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Уход члена команды | Низкая | Высокое | Документация, парное программирование |
| Изменение требований | Низкая | Среднее | Фиксация scope, change control |
| Недооценка времени | Средняя | Среднее | Буфер 30% в оценках |

---

## 6. КРИТЕРИИ УСПЕХА ПРОЕКТА

### 6.1. Функциональные критерии
- ✅ Все функции из Python версии реализованы
- ✅ Интерфейс идентичен по функциональности
- ✅ Приложение запускается без установки
- ✅ Размер exe <= 10 MB

### 6.2. Качественные критерии
- ✅ Покрытие тестами >= 70%
- ✅ Код проходит golangci-lint без ошибок
- ✅ Нет критических багов
- ✅ Производительность >= Python версии

### 6.3. Документация
- ✅ README с инструкциями
- ✅ Техническая документация
- ✅ Комментарии в коде (godoc)
- ✅ CHANGELOG

---

## 7. ИНСТРУМЕНТЫ И КОММУНИКАЦИЯ

### 7.1. Инструменты разработки
- **IDE:** VS Code с Go extension или GoLand
- **Версионирование:** Git + GitHub
- **CI/CD:** GitHub Actions (опционально)
- **Управление задачами:** GitHub Issues / Projects

### 7.2. Коммуникация
- **Ежедневные stand-ups:** 15 минут
- **Код-ревью:** Обязательно для всех PR
- **Демо:** После каждого этапа
- **Ретроспектива:** В конце проекта

---

## 8. ЧЕКЛИСТ ЭТАПОВ

### Этап 0: Подготовка
- [x] Изучение Python кода
- [x] Техническое задание
- [x] Архитектурный дизайн
- [x] План разработки
- [x] Технологический стек

### Этап 1: Настройка окружения
- [ ] Установка Go
- [ ] Установка инструментов
- [ ] Создание структуры проекта
- [ ] Инициализация Git и go.mod

### Этап 2: Модели и утилиты
- [ ] models/currency.go
- [ ] models/rate.go
- [ ] utils/number.go
- [ ] Тесты (покрытие >= 90%)

### Этап 3: Парсер ЦБ РФ
- [ ] parser/client.go
- [x] Retry логика в parser/client.go
- [x] Обработка ошибок в parser/xml.go
- [ ] parser/cbr.go
- [ ] Тесты (покрытие >= 80%)

### Этап 4: LRU кэш
- [ ] cache/lru.go
- [ ] Тесты (покрытие >= 90%)

### Этап 5: Конвертер
- [ ] converter/validator.go
- [ ] converter/formatter.go
- [ ] converter/converter.go
- [ ] Тесты (покрытие >= 85%)

### Этап 6: GUI
- [ ] gui/window.go
- [ ] gui/callbacks.go
- [ ] Ручное тестирование

### Этап 7: Главный файл и сборка
- [ ] main.go
- [ ] Сборка exe
- [ ] Проверка размера

### Этап 8: Тестирование
- [ ] Unit-тесты проходят
- [ ] Покрытие >= 70%
- [ ] Ручное тестирование
- [ ] Исправление багов

### Этап 9: Релиз
- [ ] README.md
- [ ] CHANGELOG.md
- [ ] LICENSE
- [ ] GitHub Release

---

## 9. NEXT STEPS

### После v1.0:
1. **Автообновление** - проверка и установка обновлений
2. **Системный трей** - работа в фоне
3. **Мультиязычность** - поддержка English
4. **Больше валют** - добавление других валют ЦБ РФ
5. **История конвертаций** - сохранение последних операций
6. **Темная тема** - поддержка dark mode Windows

---

**Конец документа**

**Подготовлено:** Ivan Bondarev (BiV)
**Дата:** 19.12.2025
