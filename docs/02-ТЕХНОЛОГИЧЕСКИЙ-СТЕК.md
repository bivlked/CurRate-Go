# ТЕХНОЛОГИЧЕСКИЙ СТЕК
## Проект: CurRate Go Rewrite

**Версия:** 2.1
**Дата:** 21 декабря 2025
**Обновлено:** Переход с HTML на XML API ЦБ РФ (encoding/xml + windows-1251 support)

---

## 1. ОСНОВНОЙ СТЕК

### 1.1. Язык программирования

**Go (Golang) 1.21+**

- **Официальный сайт:** https://go.dev/
- **Документация:** https://go.dev/doc/
- **Последняя стабильная:** 1.21.x (или 1.22+ если доступна)

**Почему Go:**
- ✅ Простая статическая компиляция в один exe-файл
- ✅ Встроенный HTTP клиент высокого качества
- ✅ Быстрая компиляция (секунды вместо минут)
- ✅ Простой синтаксис - легко для команды
- ✅ Встроенная поддержка concurrency (goroutines)
- ✅ Кросс-компиляция из коробки
- ✅ Отличный tooling (go fmt, go test, go mod)

---

## 2. GUI ФРЕЙМВОРК

### 2.1. Wails v2 - Go приложения с web-технологиями

**Репозиторий:** https://github.com/wailsapp/wails
**Официальный сайт:** https://wails.io/
**Документация:** https://wails.io/docs/introduction
**Версия:** v2.11.0 (последняя стабильная)
**Лицензия:** MIT

**Установка:**
```bash
# Установка Wails CLI
go install github.com/wailsapp/wails/v2/cmd/wails@latest

# Проверка установки и зависимостей
wails doctor
```

**Преимущества:**
- ✅ Современный подход: Go backend + HTML/CSS/JS frontend
- ✅ Использует нативный WebView2 (встроен в Windows 11)
- ✅ Отличная производительность (Go + нативный рендеринг)
- ✅ Простая связка Go ↔ JavaScript через автоматический биндинг
- ✅ Поддержка любых frontend фреймворков (React, Vue, Svelte) или Vanilla JS
- ✅ Активная разработка и отличная документация (1918 примеров кода)
- ✅ Размер exe 8-10 MB после UPX сжатия (целевое требование выполнено)
- ✅ Hot-reload во время разработки (`wails dev`)
- ✅ Встроенные инструменты: `wails build`, `wails dev`, `wails doctor`

**Архитектура для проекта:**

```
Frontend (HTML/CSS/JS)
    ↓ Вызовы через runtime.Call()
Go Backend (app.go)
    ↓ Использует
Converter, Parser, Cache (существующие модули)
```

**Основные компоненты:**

```go
// main.go - точка входа приложения
import (
    "github.com/wailsapp/wails/v2"
    "github.com/wailsapp/wails/v2/pkg/options"
    "github.com/wailsapp/wails/v2/pkg/options/assetserver"
    "github.com/wailsapp/wails/v2/pkg/options/windows"
)

// app.go - бизнес-логика с экспортируемыми методами
type App struct {
    ctx       context.Context
    converter *converter.Converter
}

// Методы автоматически доступны из JavaScript
func (a *App) ConvertCurrency(amount float64, currency string, date string) (*ConversionResult, error) {
    // Используем существующие модули
}
```

**Frontend структура:**
```
frontend/
├── index.html      # Главная страница
├── main.js         # JavaScript логика + вызовы Go методов
├── main.css        # Стили интерфейса
└── wailsjs/        # Автогенерируемые биндинги (создаются Wails)
    └── go/
        └── main/
            └── App.js   # TypeScript/JS обертки для Go методов
```

**Ключевые особенности для проекта:**

1. **Простой UI (5 элементов):**
   - Input для суммы
   - Radio buttons для валюты (USD/EUR)
   - Date picker для даты
   - Button "Конвертировать"
   - Label для результата + кнопка "Копировать"

2. **Нативный вид Windows:**
   - WebView2 использует Edge Chromium engine
   - Современный, знакомый пользователям интерфейс
   - Полная поддержка CSS для кастомизации

3. **Интеграция с существующим кодом:**
   - Все модули (converter, parser, cache, models) уже готовы
   - Нужен только тонкий слой адаптера (app.go)

**Системные требования:**

| Компонент | Требование |
|-----------|------------|
| **Windows** | Windows 10 1803+ (WebView2 встроен в Windows 11) |
| **Go** | 1.21+ |
| **Node.js** | 16+ (только для dev, не требуется для runtime) |
| **WebView2** | Встроен в Windows 11, автоустановка на Windows 10 |

**Документация:**
- Getting Started: https://wails.io/docs/gettingstarted/installation
- API Reference: https://wails.io/docs/reference/runtime/intro
- Examples: https://github.com/wailsapp/wails/tree/master/v2/examples
- Community Templates: https://wails.io/docs/community/templates

---

## 3. ОСНОВНЫЕ БИБЛИОТЕКИ

### 3.1. HTTP клиент

**net/http (стандартная библиотека)**

```go
import "net/http"
```

**Преимущества:**
- ✅ Встроенный в Go
- ✅ Production-ready
- ✅ HTTP/1.1 и HTTP/2 поддержка
- ✅ Автоматические редиректы
- ✅ Cookie jar
- ✅ Timeout и context поддержка

**Использование в проекте:**
```go
client := &http.Client{
    Timeout: 10 * time.Second,
    Transport: &http.Transport{
        MaxIdleConns:        10,
        IdleConnTimeout:     30 * time.Second,
        DisableCompression:  false,
    },
}
```

### 3.2. XML парсинг

**encoding/xml - стандартная библиотека Go**

- **Документация:** https://pkg.go.dev/encoding/xml
- **Лицензия:** BSD-style (часть Go)
- **Версия:** Встроена в Go стандартную библиотеку

**Преимущества:**
- ✅ Встроена в Go - не требует внешних зависимостей
- ✅ Быстрая и эффективная
- ✅ Автоматический unmarshaling в структуры Go
- ✅ Поддержка атрибутов и CDATA
- ✅ Производительность ~10x лучше HTML парсинга

**Использование в проекте:**
```go
import "encoding/xml"

// Структуры для XML ответа ЦБ РФ
type ValCurs struct {
    XMLName xml.Name `xml:"ValCurs"`
    Date    string   `xml:"Date,attr"`
    Valutes []Valute `xml:"Valute"`
}

type Valute struct {
    CharCode string `xml:"CharCode"`
    Nominal  int    `xml:"Nominal"`
    Value    string `xml:"Value"`
}

// Парсинг XML
var valCurs ValCurs
xml.Unmarshal(xmlData, &valCurs)
```

**golang.org/x/text - обработка кодировок**

- **Репозиторий:** https://github.com/golang/text
- **Документация:** https://pkg.go.dev/golang.org/x/text
- **Версия:** v0.32.0
- **Лицензия:** BSD-3-Clause

**Установка:**
```bash
go get golang.org/x/text/encoding/charmap
```

**Зачем нужно:**
- Парсинг XML ЦБ РФ в кодировке windows-1251
- Автоматическая конвертация в UTF-8

**Использование:**
```go
import "golang.org/x/text/encoding/charmap"

// Декодирование windows-1251 → UTF-8
decoder := charmap.Windows1251.NewDecoder()
utf8Data, _ := decoder.Bytes(win1251Data)
```

**Deprecated: goquery** (оставлено для обратной совместимости с HTML парсером)
- Больше не используется в основном коде после миграции на XML API
- Может быть удалено в будущих версиях

### 3.3. Буфер обмена

**atotto/clipboard - кросс-платформенный clipboard**

- **Репозиторий:** https://github.com/atotto/clipboard
- **Лицензия:** BSD-3-Clause

**Установка:**
```bash
go get github.com/atotto/clipboard
```

**Преимущества:**
- ✅ Простой API
- ✅ Кросс-платформенный (Windows/Linux/macOS)
- ✅ Легкий

**Использование:**
```go
import "github.com/atotto/clipboard"

// Копирование
err := clipboard.WriteAll("текст для копирования")

// Чтение
text, err := clipboard.ReadAll()
```

---

## 4. СТАНДАРТНАЯ БИБЛИОТЕКА GO

### 4.1. Работа с датами

**time (стандартная библиотека)**

```go
import "time"
```

**Использование в проекте:**
```go
// Парсинг даты в формате DD.MM.YYYY
date, err := time.Parse("02.01.2006", "15.12.2025")

// Форматирование
dateStr := date.Format("02.01.2006")

// Проверка, что дата не в будущем
if date.After(time.Now()) {
    return errors.New("дата не может быть в будущем")
}
```

### 4.2. Синхронизация и concurrency

**sync (стандартная библиотека)**

```go
import "sync"
```

**Использование в проекте:**
- `sync.Mutex` - для защиты кэша
- `sync.RWMutex` - для read-write lock кэша
- `sync.Map` - thread-safe map (альтернатива кастомному кэшу)

### 4.3. Контекст и отмена операций

**context (стандартная библиотека)**

```go
import "context"
```

**Использование в проекте:**
```go
// Создание контекста с таймаутом для HTTP запроса
ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
defer cancel()

req, _ := http.NewRequestWithContext(ctx, "GET", url, nil)
```

### 4.4. Строки и форматирование

**strings, strconv, fmt (стандартная библиотека)**

```go
import (
    "strings"
    "strconv"
    "fmt"
)
```

**Использование в проекте:**
- Парсинг и нормализация суммы
- Форматирование результата
- Обработка строк

---

## 5. КЭШИРОВАНИЕ

### 5.1. Варианты реализации

#### Вариант 1: Кастомный LRU кэш
**Преимущества:**
- ✅ Полный контроль над поведением
- ✅ Точное соответствие Python реализации
- ✅ Нет дополнительных зависимостей

**Реализация:**
```go
type CurrencyCache struct {
    mu       sync.RWMutex
    cache    map[string]cacheEntry
    lru      *list.List  // container/list
    maxSize  int
    ttl      time.Duration
}

type cacheEntry struct {
    rate      float64
    timestamp time.Time
    element   *list.Element
}
```

#### Вариант 2: golang-lru библиотека
- **Репозиторий:** https://github.com/hashicorp/golang-lru
- **Лицензия:** MPL-2.0
- ✅ Проверенная реализация от HashiCorp
- ✅ Простой API
- ❌ Дополнительная зависимость

**Рекомендация:** Начать с Варианта 1 (кастомный LRU)

---

## 6. ИНСТРУМЕНТЫ РАЗРАБОТКИ

### 6.1. Компилятор и runtime

**Go toolchain**
```bash
# Установка Go
winget install GoLang.Go

# Проверка версии
go version
```

### 6.2. Сборка проекта

**Wails Build System**

Wails использует свою систему сборки, которая автоматически компилирует Go backend и bundling frontend:

```bash
# Development режим с hot-reload
wails dev

# Production сборка
wails build

# Production с оптимизацией размера
wails build -ldflags "-s -w"

# Проверка конфигурации и зависимостей
wails doctor
```

**Автоматические флаги Wails:**
- Development: `-tags dev -gcflags "all=-N -l"`
- Production: `-tags desktop,production -ldflags "-w -s"`
- Windows production: добавляется `-H windowsgui` (скрывает консоль)

**Дополнительные опции сборки:**
```bash
# Указать директорию вывода
wails build -o ./dist

# Кастомные ldflags (добавляются к дефолтным)
wails build -ldflags "-X main.version=1.0.0"

# Пропустить frontend build (если уже собран)
wails build -s

# Clean build (без кэша)
wails build -clean
```

**Структура после сборки:**
```
build/
└── bin/
    └── currate.exe    # Production-ready исполняемый файл
```

**Флаги оптимизации (автоматически применяются):**
- `-s` - убрать символьную таблицу
- `-w` - убрать DWARF debug информацию
- `-H windowsgui` - скрыть консольное окно (Windows)
- `-trimpath` - убрать абсолютные пути из бинарника

### 6.3. Управление зависимостями

**Go modules (встроенный)**
```bash
# Инициализация модуля
go mod init github.com/bivlked/currate-go

# Добавление зависимостей
go get github.com/wailsapp/wails/v2
go get github.com/PuerkitoBio/goquery
go get github.com/atotto/clipboard

# Обновление зависимостей
go get -u ./...

# Очистка неиспользуемых зависимостей
go mod tidy

# Скачивание зависимостей
go mod download
```

**go.mod пример:**
```go
module github.com/bivlked/currate-go

go 1.21

require (
    github.com/wailsapp/wails/v2 v2.11.0
    github.com/PuerkitoBio/goquery v1.11.0
    github.com/atotto/clipboard v0.1.4
)
```

**Frontend зависимости (опционально):**

Для Vanilla JavaScript проекта Node.js зависимости не требуются в runtime.
Если используется фреймворк (React/Svelte), устанавливаются через:

```bash
cd frontend
npm install

# При сборке Wails автоматически запускает:
# npm install  (если package.json изменился)
# npm run build (перед компиляцией Go)
```

### 6.4. Тестирование

**go test (встроенный)**
```bash
# Запуск всех тестов
go test ./...

# С покрытием кода
go test -cover ./...

# HTML отчет покрытия
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out

# Только быстрые тесты (пропустить интеграционные)
go test -short ./...
```

**Таблично-ориентированные тесты (table-driven tests):**
```go
func TestParseAmount(t *testing.T) {
    tests := []struct {
        name    string
        input   string
        want    float64
        wantErr bool
    }{
        {"simple", "1000", 1000.0, false},
        {"with spaces", "1 000", 1000.0, false},
        {"negative", "-100", 0, true},
    }
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, err := ParseAmount(tt.input)
            if (err != nil) != tt.wantErr {
                t.Errorf("error = %v, wantErr %v", err, tt.wantErr)
            }
            if got != tt.want {
                t.Errorf("got = %v, want %v", got, tt.want)
            }
        })
    }
}
```

### 6.5. Форматирование и линтинг

**gofmt / gofumpt**
```bash
# Форматирование всех файлов
go fmt ./...

# Или с gofumpt (более строгий форматировщик)
gofumpt -l -w .
```

**golangci-lint - мета-линтер**

- **Сайт:** https://golangci-lint.run/
- **Установка:** https://golangci-lint.run/usage/install/

```bash
# Установка
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# Запуск
golangci-lint run

# С конфигурацией
golangci-lint run --config .golangci.yml
```

**Рекомендуемые линтеры:**
- `errcheck` - проверка неиспользованных ошибок
- `govet` - стандартный vet
- `staticcheck` - дополнительные проверки
- `gosimple` - упрощения кода
- `ineffassign` - неиспользуемые присваивания
- `unused` - неиспользуемый код

### 6.6. Компрессия exe

**UPX - Ultimate Packer for eXecutables**

- **Сайт:** https://upx.github.io/
- **Установка:** https://github.com/upx/upx/releases

```bash
# Сжатие exe (опционально)
upx --best --lzma currate.exe

# Результат: сжатие на 40-60%
# Пример: 8 MB → 3-4 MB
```

⚠️ **Примечание:** UPX может вызвать false-positive в антивирусах. Использовать опционально.

---

## 7. ВЕРСИОНИРОВАНИЕ И CI/CD

### 7.1. Git

**Структура репозитория:**
```
currate-go/
├── .git/
├── .gitignore
├── .golangci.yml          # Конфигурация линтера
├── go.mod                 # Зависимости
├── go.sum                 # Checksums зависимостей
├── README.md
├── LICENSE
├── cmd/
│   └── currate/
│       └── main.go        # Точка входа
├── internal/              # Приватный код
│   ├── gui/
│   ├── converter/
│   ├── parser/
│   └── cache/
├── pkg/                   # Публичный код (если нужен)
├── docs/                  # Документация
└── .github/
    └── workflows/
        └── build.yml      # GitHub Actions
```

### 7.2. GitHub Actions (CI/CD)

**build.yml пример для Wails:**
```yaml
name: Build Wails App

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test ./...

      - name: Build Wails app
        run: wails build -clean

      - name: Compress with UPX (optional)
        run: |
          # Скачать UPX
          curl -L https://github.com/upx/upx/releases/download/v4.2.1/upx-4.2.1-win64.zip -o upx.zip
          unzip upx.zip
          # Сжать exe
          ./upx-4.2.1-win64/upx.exe --best --lzma ./build/bin/currate.exe

      - uses: actions/upload-artifact@v4
        with:
          name: currate-windows
          path: build/bin/currate.exe
```

---

## 8. ДОПОЛНИТЕЛЬНЫЕ ИНСТРУМЕНТЫ

### 8.1. Отладка

**Delve - Go debugger**
```bash
# Установка
go install github.com/go-delve/delve/cmd/dlv@latest

# Отладка
dlv debug ./cmd/currate
```

### 8.2. Профилирование

**pprof (встроенный)**
```go
import (
    "runtime/pprof"
    "os"
)

// CPU профилирование
f, _ := os.Create("cpu.prof")
pprof.StartCPUProfile(f)
defer pprof.StopCPUProfile()

// Память профилирование
f, _ := os.Create("mem.prof")
pprof.WriteHeapProfile(f)
```

```bash
# Анализ
go tool pprof cpu.prof
go tool pprof mem.prof
```

### 8.3. Документация

**godoc**
```bash
# Локальный сервер документации
go install golang.org/x/tools/cmd/godoc@latest
godoc -http=:6060

# Открыть в браузере
# http://localhost:6060/pkg/
```

---

## 9. РЕКОМЕНДАЦИИ ПО СТРУКТУРЕ КОДА

### 9.1. Структура пакетов для Wails проекта

```
currate-go/
├── main.go           # Точка входа Wails приложения
├── app.go            # App структура с методами для frontend
├── wails.json        # Конфигурация Wails проекта
├── go.mod / go.sum   # Go зависимости
├── frontend/         # Frontend приложение
│   ├── index.html    # HTML разметка
│   ├── main.js       # JavaScript логика
│   ├── main.css      # Стили
│   └── wailsjs/      # Автогенерируемые биндинги (создаются Wails)
│       └── go/
│           └── main/
│               └── App.js
├── build/            # Артефакты сборки
│   ├── bin/          # Скомпилированные exe
│   ├── appicon.png   # Иконка приложения
│   └── windows/      # Windows-специфичные ресурсы
├── internal/         # Внутренние модули (уже реализованы)
│   ├── app/          # Wails app adapter (новый)
│   │   └── app.go
│   ├── converter/    # Бизнес-логика конвертации ✅
│   │   ├── converter.go
│   │   ├── validator.go
│   │   └── formatter.go
│   ├── parser/       # Парсинг ЦБ РФ ✅
│   │   ├── cbr.go
│   │   ├── client.go
│   │   └── parser.go
│   ├── cache/        # LRU кэш ✅
│   │   └── lru.go
│   └── models/       # Модели данных ✅
│       ├── currency.go
│       └── rate.go
├── pkg/              # Публичные утилиты
│   └── utils/
│       └── number.go
└── docs/             # Документация
    ├── 01-ТЕХНИЧЕСКОЕ-ЗАДАНИЕ.md
    ├── 02-ТЕХНОЛОГИЧЕСКИЙ-СТЕК.md
    └── ...
```

**Ключевые отличия от Walk:**
- `frontend/` вместо `internal/gui/` - полное разделение UI и логики
- `app.go` - адаптер между Wails и бизнес-логикой
- `wails.json` - конфигурация проекта (аналог project.json в других фреймворках)
- Автогенерируемые биндинги в `frontend/wailsjs/`

### 9.2. Соглашения по именованию

**Файлы:**
- `lowercase_with_underscores.go` (snake_case)
- Или `lowercasenounderscore.go` (все строчными)

**Пакеты:**
- `lowercase` (одно слово, строчными)
- Примеры: `converter`, `parser`, `cache`

**Типы:**
- `PascalCase` для экспортируемых
- `camelCase` для приватных

**Функции:**
- `PascalCase` для экспортируемых
- `camelCase` для приватных

**Константы:**
- `PascalCase` для экспортируемых
- `camelCase` для приватных
- Или `UPPER_CASE` для глобальных констант (опционально)

---

## 10. ИТОГОВЫЙ СПИСОК ЗАВИСИМОСТЕЙ

### 10.1. Runtime зависимости

```go
require (
    github.com/wailsapp/wails/v2 v2.11.0
    github.com/PuerkitoBio/goquery v1.11.0
    github.com/atotto/clipboard v0.1.4
)
```

**Непрямые зависимости (основные):**
```go
require (
    github.com/andybalholm/cascadia v1.3.3 // indirect (от goquery)
    golang.org/x/net v0.47.0 // indirect (от goquery)
    golang.org/x/sys v0.39.0 // indirect
    github.com/wailsapp/mimetype v1.4.1 // indirect (от wails)
    github.com/wailsapp/go-webview2 v1.0.16 // indirect (WebView2 биндинг)
)
```

**Системные зависимости:**
- **Windows:** WebView2 Runtime (встроен в Windows 11, автоустановка на Windows 10)
- **Go:** 1.21+ runtime
- **Node.js:** 16+ (только для разработки, не требуется в production)

### 10.2. Development зависимости

```bash
# Wails CLI (обязательно)
go install github.com/wailsapp/wails/v2/cmd/wails@latest

# Линтер
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# Debugger
go install github.com/go-delve/delve/cmd/dlv@latest

# Форматтер
go install mvdan.cc/gofumpt@latest
```

**Проверка установки Wails:**
```bash
wails doctor
# Проверяет:
# - Go версию
# - Node.js (для dev)
# - WebView2 runtime
# - Системные зависимости
```

---

## 11. ЦЕЛЕВЫЕ МЕТРИКИ

### 11.1. Размер финального exe (Wails + Vanilla JS)

| Конфигурация | Ожидаемый размер | Статус |
|--------------|------------------|--------|
| `wails build` (базовая) | ~12-15 MB | Vanilla JS без фреймворков |
| `wails build -ldflags "-s -w"` | ~12-15 MB | Флаги уже применяются по умолчанию |
| С UPX компрессией (`--best --lzma`) | **~8-10 MB** | ✅ **Целевое требование выполнено** |

**Сравнение размеров (референс):**
- Walk нативный: 3-5 MB
- Wails + Vanilla JS: 12-15 MB → 8-10 MB (с UPX)
- Wails + React: 18-25 MB → 12-15 MB (с UPX)

**Причина увеличения размера:**
- WebView2 биндинги (~3-4 MB)
- Wails runtime (~5-6 MB)
- Bundled frontend (~2-3 MB)
- Go backend + бизнес-логика (~2-3 MB)

**Компромисс:** Размер больше, но выигрываем в:
- Современный UI с полной поддержкой CSS
- Простота разработки и поддержки
- Активная поддержка фреймворка
- Возможность использовать любые web-технологии

### 11.2. Зависимости

- **Прямые зависимости:** 3 (wails, goquery, clipboard)
- **Все зависимости (с транзитивными):** ~15-20 (включая wails подзависимости)
- **Системные:** WebView2 Runtime (уже есть в Windows 11)

### 11.3. Время сборки

| Тип сборки | Время | Примечание |
|------------|-------|------------|
| **Первая сборка** (`wails build`) | 40-90 секунд | С загрузкой зависимостей + frontend build |
| **Инкрементальная** (`wails build`) | 5-15 секунд | Кэширование Go + frontend |
| **Development** (`wails dev`) | 10-20 секунд | Hot-reload после этого |
| **CI/CD** (полный цикл) | 2-3 минуты | Тесты + сборка + UPX |

### 11.4. Требования к системе разработчика

| Компонент | Минимум | Рекомендуется |
|-----------|---------|---------------|
| **RAM** | 4 GB | 8 GB+ |
| **Диск** | 2 GB свободно | 5 GB+ (для кэша Node.js/Go) |
| **CPU** | 2 ядра | 4+ ядра (параллельная сборка) |
| **ОС** | Windows 10 1803+ | Windows 11 |

---

**Конец документа**

---

**Подготовлено:** Ivan Bondarev (BiV)
**Дата создания:** 19.12.2025
**Обновлено:** 20.12.2025 (v2.0 - переход на Wails v2.11.0)
